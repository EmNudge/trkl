!function(t,s){define&&define.amd?define([],s):module&&module.exports?module.exports=s():t.trkl=s()}(this,function(){function t(t,s){this.t=s,s&&this.s(),this.i=s?this.i:t,this.e=this.i,this.n=0,this.r=-1,this.u=[],this.h=[]}let s=null,i=[],e=function(s){let i=new t(s),e=function(){return arguments.length?i.write(arguments[0]):i.read()};return e.subscribe=i.sub.bind(i),e.unsubscribe=i.unsub.bind(i),e};e.computed=function(s){let i=new t(0,s),e=i.read.bind(i);return e.subscribe=i.sub.bind(i),e.unsubscribe=i.unsub.bind(i),e},e.from=function(t){let s=e();return t(s),s};let n={};return t.prototype=n,n.sub=function(t,s){-1==this.h.indexOf(t)&&this.h.push(t),s&&t(this.i,this.lastVal)},n.unsub=function(t){let s=this.h.indexOf(t);s>-1&&this.h.splice(s,1)},n.read=function(){return s&&-1==this.u.indexOf(s)&&(this.u.push(s),this.n&&s.setStale()),this.i},n.s=function(){s=this,this.l=this.i;let t;try{this.i=this.t()}catch(s){t=s}if(s=null,t)throw this.onError(),t;this.e=this.l},n.onError=function(){this.i=this.l,this.n=0,this.u&&this.u.forEach(t=>t.onError())},t.validate=function(){let s;for(let t=0;t<i.length;t++)if(null!==i[t]){s=i[t];break}i.length=0,s&&t.foundCircular(s)},t.foundCircular=function(t){throw new Error("Circular dependency detected. Trkl has stopped. Suspicious function is: "+t.t.toString())},n.write=function(s){this.l=this.i,this.o(),this.i=s;try{this.c()}catch(t){throw this.onError(),t}return t.validate(),this.a(),this.i},n.setStale=function(){1==++this.n&&(this.u.forEach(t=>t.setStale()),this._())},n._=function(){this.r=i.length,i[this.r]=this},n.d=function(){i[this.r]=null,this.r=-1},n.setReady=function(){1==this.n&&this.t&&this.s(),0==--this.n&&(this.d(),this.c(),this.a())},n.c=function(){for(let t=0;t<this.u.length;t++)this.u[t].setReady()},n.o=function(){for(let t=0;t<this.u.length;t++)this.u[t].setStale()},n.a=function(){if(this.h.length)for(let t=0;t<this.h.length;t++)this.b(this.h[t])},n.b=function(t){let s;try{t(this.i,this.e)}catch(t){s=t}s&&window.setTimeout(()=>{throw s},0)},e});